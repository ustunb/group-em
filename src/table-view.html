<!doctype html>
<meta charset='utf-8'>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="../external_js/lodash.js"></script>
<script src="../external_js/jquery-1.12.2.js"></script>
<script src="../external_js/jquery-ui.js"></script>
<script src="../external_js/jquery.tooltipster.min.js"></script>
<link href="../src/toggle_button.css" rel="stylesheet">
<link href='https://fonts.googleapis.com/css?family=Raleway:400,300' rel='stylesheet' type='text/css'>
<link rel='stylesheet' href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css">

<link rel="stylesheet" href="../src/sidebar.css">
<link rel='stylesheet' href="../src/table-view.css">
<link type="text/css" rel='stylesheet' href="css/jquery.pagewalkthrough.css">


<body class = "hideprefs">
<div class="container">
<div class="sidebar">
<div style="position: relative; text-align: center; margin: 30px 0; height:150px; " >

<div id = "logo_container">
<a id = "logo_link" href="../index.html">
<div id = "logo_icon"></div>
<div id = 'logo_name'></div>
</a>
</div>
</div>
<div id='cssmenu'>
<ul>
   <li class='active' ><a id='link_to_table_view' href='#'></a></li>
   <li class='last'><a id='link_to_group_view' href='group-view.html'></a></li>
   <li class='teachermode_switch'>
      <p><label>
        <span id='teachermode_text'>preferences</span>

        <span class="switch">
            <input id="cmn-toggle-4" class="cmn-toggle cmn-toggle-round-flat init" type="checkbox">
            <label for="cmn-toggle-4"></label>
        </span>
      </label></p>
    </li>
    <li>
      <a id = "new_class">New Class</a>
    </li>
    <li>
      <div class = "invisible" id = "undo_div"><a id = "undo"><span class="fa fa-undo"></span> Undo</a></div>
    </li>
    <li>
      <a id = "help_button" href="#about-popup">about</a>
    </li>
</ul>
</div>
</div>

<div class="content">
<div id="error1" class="alert-box error"><span>error: </span>Enter a valid student name</div>
<table class="classroom">
<thead>
<tr>
<th id="classname_row" colspan="4">
<!-- positioned at top right
<div class = "invisible" id = "undo_div"><a id = "undo" class="fa fa-undo">   Undo</a></div>
-->
<input type="text" id="classname_input"></input>
</th>
</tr>
<tr class="heading_row">
  <th unselectable="on" class="student_name">Student Name</th>
  <th unselectable="on" class="pair_with">Pair With</th>
  <th unselectable="on" class="dont_pair_with">Don't Pair With</th>
  <th unselectable="on" class="remove"></th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr>
<th id='add_student_row' colspan="4">
  <textarea id="add_student_box"></textarea>
</th>
</tr>
<tr>

<th id="button_row" colspan="4">
<div id="control_container">
<div id="button_container" class="tooltip"><button id="groupem_button" class="control_button" disabled>group'em</button></div>
<div id="group_size_container"><div id="group_size_icon_container"></div></div>
<div id="increment_container">
<div id="increase_button_container"><button id="increase_group_size" class="increment_button control_button"></button></div>
<div id="decrease_button_container"><button id="decrease_group_size" class="increment_button control_button"></button></div>
</div>
</div>
</th>

</tr>
</tfoot>
</table>


<div id="about-popup" class="overlay">
    <div class="popup">
    <a class="close-popup" href="#">&times;</a>
      
    <br><br><br><br>
    <h2>group'em is is a tool to create student groups for class projects or in-class activities.<h2>
    <br>
    
      <span id="about-text">
        Created by 
        <a href="https://www.linkedin.com/in/shrutibanda/">Shruti Banda</a>,
        <a href="http://www.davidbau.com/">David Bau</a>, 
        <a href="https://www.linkedin.com/in/nicholas-sledeski-30950265">Nick Sledeski</a>,
        and <a href="http://www.berkustun.com/">Berk Ustun</a><br>
        
        Source code for this website is available on <a href="https://github.com/ustunb/group-em/">GitHub</a><br>
        For more information, contact <a href="http://www.berkustun.com">Berk Ustun</a><br>
        
      </span>
  </div>
</div>


</body>
<script src="../src/classlist.js"></script>
<script src="../src/student.js"></script>
<script>


var ADD_INITIAL_LIST = false;
var ADD_CLASSNAME_PLACEHOLDER = "enter class name"
var ADD_STUDENT_BOX_PLACEHOLDER = "paste or enter student names like this:\nAlice, Bob, Cory, Dana"
var REVERT_SPEED_DURATION = 500;
var MIN_STUDENTS_PER_GROUP = 2;
var MAX_STUDENTS_PER_GROUP = Number.POSITIVE_INFINITY;
var DRAGGABLE_Z_INDEX = 3;
var GROUP_SIZE_FADE_SPEED = 50;

var classroom = new Classlist();
$("#group_size_container").data('students_per_group', MIN_STUDENTS_PER_GROUP);

$("#button_container").tooltipster({
    position: 'right',
  });

//format duplicate student names
var adjustNameForDuplicates = function(studentName, classroom){
  var MAX_DUPLICATE_NAMES = 1000;
  var currentNames = classroom.getStudentNames();
  console.log(currentNames)
  var duplicateCount = 1;
  var proposedName = studentName;
  while (duplicateCount < MAX_DUPLICATE_NAMES){
    console.log(proposedName)
    console.log(_.includes(currentNames, proposedName))
    if (_.includes(currentNames, proposedName)){
      duplicateCount++;
      proposedName = studentName + " " + duplicateCount.toString();
    } else {
      break
    }
  }
  studentName = proposedName;
  return studentName;
}

//parse student list from textbox
var parseStudentList = function(classroom) {
/**
text format:
- no tab characters
- names must be separated by commas

spreadsheet format:
- no headers! 
- case sensitive
- names in column 1, prefer in column 2, avoid in column 3; 
- users can paste in column 1, column 1+2, column 1+2+3 but not 1+3
- duplicate names will be parsed and incremented (David, David 2, David 3)
- if a students name is duplicated, and that name is in preferences, then parser will interpret first instance
- all names listed in the preferences from a spreadsheet must be included in the student column of that spreadsheet
- if a name in the preferences is not in the student column, then it is dropped
- preferences are validated (student cannot prefer self, student cannot simultaneously prefer/avoid self); 
- incoherent preferences are dropped
- if user adds David by textbox first, then adds spreadsheet with David under preferences then David is dropped
*/

    var rawText = $("#add_student_box").val();
    rawText = rawText.replace(/\n/g, '1)(*3hf:Z'); //remove newlines
    rawText = rawText.replace(/\r\n/g, '1)(*3hf:Z'); //remove windows newlines
    rawText = rawText.split('1)(*3hf:Z'); //magic
    rawText = _.compact(rawText); //remove blank spaces
    // console.log('raw_text before parsing', rawText);

    //determine if text is spreadsheet or not
    var rawTextHasSingleRow = (rawText.length == 1);
    var rawTextContainsTabs = (rawText[0].search(/\t/g) > 0);
    var rawTextHasMultipleNamesInNameColumn = (rawText[0].split(",").length > 1);
    var parseText = rawTextHasMultipleNamesInNameColumn || (rawTextHasSingleRow && !rawTextContainsTabs);
    var parseSpreadsheet = !parseText;

    //parse normal text
    if (parseText) {
        console.log('PARSING TEXT FROM INPUT BOX AS TEXT');
        for (var i = 0; i < rawText.length; i++) {
            var row = rawText[i].replace(/\t/g, '1)(*3hf:Z');
            row = row.split('1)(*3hf:Z');
            if (row.length > 0) {
                raw_name_column = row[0].split(",");
                for (var k = 0; k < raw_name_column.length; k++) {
                    var name = raw_name_column[k].trim();
                    if (name.length > 0) {
                        var studentID = classroom.getNextStudentID();
                        var studentName = adjustNameForDuplicates(name, classroom);
                        classroom.add(new Student(studentName, studentID));
                    }
                }
            }
        }
    }

    //parse spreadsheet text
    if (parseSpreadsheet) {
        console.log('PARSING TEXT FROM INPUT BOX AS SPREADSHEET');
        
        //parse names, prefer preferences and avoid preferences into separate lists
        var parsedNames = [];
        var parsedPrefer = [];
        var parsedAvoid = [];

        for (var i = 0; i < rawText.length; i++) {
            var row = rawText[i].replace(/\t/g, '1)(*3hf:Z');
            row = row.split('1)(*3hf:Z');
            if (row.length > 0) {
                
                name_cell = row[0].split(",");
                name_cell = _.head(_.compact(_.map(name_cell, _.trim)));
                var prefer_cell = [];
                var avoid_cell = [];
                if (row.length > 1) {
                    prefer_cell = row[1].split(",");
                }
                if (row.length > 2){
                    avoid_cell = row[2].split(",");
                }
                prefer_cell = _.compact(_.map(prefer_cell,_.trim));
                avoid_cell = _.compact(_.map(avoid_cell,_.trim));
                
                parsedNames.push(name_cell);
                parsedPrefer.push(prefer_cell);
                parsedAvoid.push(avoid_cell);
            }
        }

        // console.log('parsedNames', parsedNames)
        // console.log('parsedPrefer', parsedPrefer)
        // console.log('parsedAvoid', parsedAvoid)

        //add students one by one to the classroom object and create a name to ID dictionary
        var nameToID = {};
        var preferenceArray = [];
        for (var i = 0; i < parsedNames.length; i++) {
            var studentID = classroom.getNextStudentID();
            var studentName = adjustNameForDuplicates(parsedNames[i], classroom);
            var successfulAddition = classroom.add(new Student(studentName, studentID));
            if (successfulAddition) {
                nameToID[parsedNames[i]] = studentID;
                preferenceArray.push({
                    id: studentID,
                    name: parsedNames[i],
                    prefer: parsedPrefer[i],
                    avoid: parsedAvoid[i],
                });
            }
        }

        //translate preferences from names to IDs and validate preferences
        for (var i = 0; i < preferenceArray.length; i++) {
            var studentID = preferenceArray[i]['id'];
            var studentName = preferenceArray[i]['name'];
            var preferNames = preferenceArray[i]['prefer'];
            var avoidNames = preferenceArray[i]['avoid'];
            // console.log('id', studentID, 'name', studentName, 'preferNames', preferNames, 'avoidNames', avoidNames);

            //translate names to ids
            var preferIDs = [];
            var avoidIDs = [];
            for (var j = 0; j < preferNames.length; j++) {
                if (preferNames[j] in nameToID) {
                    preferIDs.push(nameToID[preferNames[j]]);
                }
            }
            for (var j = 0; j < avoidNames.length; j++) {
                if (avoidNames[j] in nameToID) {
                    avoidIDs.push(nameToID[avoidNames[j]]);
                }
            }

            //validate preferences (cannot contain own ID; must be unique; no conflicts)
            preferIDs = _.difference(preferIDs, [studentID])
            avoidIDs = _.difference(avoidIDs, [studentID])
            var conflicts = _.intersection(preferIDs, avoidIDs);
            if (conflicts.length > 0) {
                console.log('user inputted conflicting preferences!')
                preferIDs = _.difference(preferIDs, conflicts);
                avoidIDs = _.difference(avoidIDs, conflicts);
            }
            preferenceArray[i]['prefer'] = preferIDs;
            preferenceArray[i]['avoid'] = avoidIDs;
            // console.log('id', studentID, 'name', studentName, 'preferIDs', preferIDs, 'avoidIDs', avoidIDs);
        }

        //add preferences to each student
        for (var i = 0; i < preferenceArray.length; i++) {
            var studentID = preferenceArray[i]['id'];
            var preferIDs = preferenceArray[i]['prefer'];
            var avoidIDs = preferenceArray[i]['avoid'];
            student = classroom.getStudentFromID(studentID);
            // console.log('before', student.toString());
            for (var j = 0; j < preferIDs.length; j++) {
                student.addToPreferences('prefer', preferIDs[j]);
            }
            for (var j = 0; j < avoidIDs.length; j++) {
                student.addToPreferences('avoid', avoidIDs[j]);
            }
            // console.log('after', student.toString());
        }
    }
    return classroom;
}



var updateGroupemButton = function(classroom){
  var students_per_group = $("#group_size_container").data('students_per_group');
  if (students_per_group <= classroom.getSize()){
    $("#groupem_button").prop('disabled', false);
    $("#button_container").tooltipster('content', 'HELLO')
  } else {
    $("#groupem_button").prop('disabled', true);
    //$("#button_container").tooltipster('content', 'need at least ' + students_per_group + ' students in classroom to create groups of ' + students_per_group);
    $("#button_container").tooltipster('content', 'HELLO')
  }
}

var updateStudentsPerGroup = function(classroom, new_students_per_group){ 
    
    $("#group_size_container").data('students_per_group', new_students_per_group);
    
    if (new_students_per_group == 1){
      var iconHTML = '<span id="group_size_icon_1x" class = "group_size_icon">&#xf007</span>';
    } else if (new_students_per_group == 2){
      var iconHTML = '<span id="group_size_icon_2x" class = "group_size_icon">&#xf007&#xf007</span>';
    } else if (new_students_per_group == 3){
      var iconHTML = '<span id="group_size_icon_3x" class = "group_size_icon">&#xf007&#xf007&#xf007</span>';
    } else if (new_students_per_group == 4){
      var iconHTML = '<span id="group_size_icon_4x" class = "group_size_icon">&#xf007&#xf007&#xf007&#xf007</span>';
    } else if (new_students_per_group > 4){
      var iconHTML = '<span id="group_size_icon_nx" class = "group_size_icon"> &#xf235 <p id="group_size_icon_nx_number">' + new_students_per_group + '</p></span>';
    }
    $("#group_size_icon_container").html(iconHTML);
    //$("#group_size_container").fadeOut(GROUP_SIZE_FADE_SPEED).fadeIn('slow')
    updateGroupemButton(classroom);
}

//redraws table at each state change
var updatePage = function(classroom) {
  // Put UI in special mode if the classroom is empty.
  var classsize = classroom.getStudents().length;
  $('body').toggleClass('emptyclassroom', classsize == 0);
  $('body').toggleClass('mediumclassroom', classsize > 5);
  $('body').toggleClass('largeclassroom', classsize > 10);

  var scrollLeft = window.pageXOffset ||
  (document.documentElement || document.body.parentNode || document.body).scrollLeft;

  var scrollTop  = window.pageYOffset ||
  (document.documentElement || document.body.parentNode || document.body).scrollTop;
  $('table tbody').empty();
  if (classroom.getSize() > 0){
    var studentArray = classroom.getStudents();
    for (var i = 0; i < studentArray.length; i++) {
      addRow(studentArray[i], classroom, scrollLeft, scrollTop);
    }
  }
  updateGroupemButton(classroom);
  updateLocalStorage(classroom);
}

var updateLocalStorage = function(classroom){
  localStorage.setItem('classroom', classroom.toJSON());
  var student_per_group = $("#group_size_container").data('students_per_group');
  if (Number(student_per_group) === student_per_group && student_per_group % 1 === 0){
    localStorage.setItem('students_per_group', $("#group_size_container").data('students_per_group'));
  }
}

function getTileHTML(name, type, tileID, tileClasses){
  var result = $('<p>').text(name);
  if (tileID != null) {
    result.attr('id', tileID);
  }
  if (tileClasses != null) {
    result.addClass(tileClasses.join(' '));
  }
  if (type == 'prefer') {
    result.append($("<span class='removePreferTile'></span>"));
  }
  if (type == 'avoid') {
    result.append($("<span class='removeAvoidTile'></span>"));
  }
  return result;
}


//adds a new row to the table; all elements are have IDs derived from the student ID
function addRow(student, classroom, scrollLeft, scrollTop) {

  //element / ID overview
  //tile_name_[SID1]: ID for tile with student SID1 in "student_name" column
  //tile_prefer_[SID1]_[SID2]: ID for tile with student SID2 in "prefer" column of student [SID1]
  //tile_avoid_[SID1]_[SID2]: ID for tile with student SID2 in "avoid" column of student [SID1]
  //class: tile_[SID] : class name for any tile student SID name on it 
  
  //get new student ID
  //console.log(student.toString())

 
  var studentID = student.id();
  var studentName = student.name();
  
  //define IDs for table row and cell
  var rowID = "row_" + studentID;
  var nameID = "name_cell_" + studentID;
  var preferID = "prefer_cell_" + studentID;
  var avoidID = "avoid_cell_" + studentID;
  var removeID = 'delete_cell_' + studentID;

  //define jQuery selectors for table row and each cell
  var row = "#" + rowID;
  var nameCell = "#" + nameID
  var preferCell = "#" + preferID
  var avoidCell = "#" + avoidID
  var removeCell = "#" + removeID
  
  //add new row + cells
  $('table tbody').append('<tr id = ' + rowID +'></tr>');
  $(row).append("<td class='student_name' id=" + nameID + "></td>")
  $(row).append("<td class='pair_with' id=" + preferID + "></td>")
  $(row).append("<td class='dont_pair_with' id=" + avoidID + "></td>")
  $(row).append("<td class='remove' id=" + removeID + "></td>")  

  //add data to all other elements
  $(row).data("studentID", studentID)
  $(preferCell).data('studentID', studentID)
  $(nameCell).data("studentID", studentID)
  $(avoidCell).data("studentID", studentID)
  $(removeCell).data("studentID", studentID)

  //add name tile
  var tileID  = "tile_name_" + studentID;
  var tileHTML = getTileHTML(studentName, "name", tileID, ["tile_name"])
  $(nameCell).append(tileHTML)

  //add pair with tiles  (data contains studentID of tile_name)
  var prefIDs = student.getPreferences('prefer');
  for (i = 0; i < prefIDs.length; i++) {
    var targetStudent = classroom.getStudentFromID(prefIDs[i]);
    var tileID = "tile_prefer_" + studentID + "_" + prefIDs[i];
    var tileClasses = ["tile_prefer", "tile_" + prefIDs[i]];
    var tileHTML = getTileHTML(targetStudent.name(), "prefer", tileID, tileClasses)
    $(preferCell).append(tileHTML);
    $("#" + tileID).data('studentID', prefIDs[i]);
  }

  //add dont_pair_with tiles (data contains studentID of tile_name)
  var avoidIDs =  student.getPreferences('avoid');
  for (i = 0; i < avoidIDs.length; i++) {
    var targetStudent = classroom.getStudentFromID(avoidIDs[i]);
    var tileID = "tile_avoid_" + studentID + "_" + avoidIDs[i];
    var tileClasses = ["tile_avoid", "tile_" + avoidIDs[i]];
    var tileHTML = getTileHTML(targetStudent.name(), "avoid", tileID, tileClasses);
    $(avoidCell).append(tileHTML);
    $("#" + tileID).data('studentID', avoidIDs[i]);  
  }

  // Make the sidebar as tall as any content.
  $('.sidebar').height(Math.max($(window).height(), $(document).height()));
  // Do it again in a moment after other things may have changed!
  setTimeout(function() {
    $('.sidebar').height(Math.max($(window).height(), $(document).height()));
  }, 0);
  window.scrollTo(scrollLeft, scrollTop);
}

//HANDLE COPY PASTING  http://stackoverflow.com/questions/3211505/detect-pasted-text-with-ctrlv-or-right-click-paste
function getTextAreaSelection(textarea) {
  var start = textarea.selectionStart, end = textarea.selectionEnd;
  return {
    start: start,
    end: end,
    length: end - start,
    text: textarea.value.slice(start, end)
  };
}

function detectPaste(textarea, callback) {
  textarea.onpaste = function() {
    var sel = getTextAreaSelection(textarea);
    var initialLength = textarea.value.length;
    window.setTimeout(function() {
      var val = textarea.value;
      var pastedTextLength = val.length - (initialLength - sel.length);
      var end = sel.start + pastedTextLength;
      callback({
        start: sel.start,
        end: end,
        length: pastedTextLength,
        text: val.slice(sel.start, end)
      });
    }, 1);
  };
}

/**
  var textarea = document.getElementById("your_textarea");
  detectPaste(textarea, function(pasteInfo) {
  alert(pasteInfo.text);
// pasteInfo also has properties for the start and end character
// index and length of the pasted text
});
 **/
$(document).ready(function() {

  $("#add_student_box").focus();
  
  $(document).on('click', ".remove", function(e) {
    var removedStudentID = $(this).data('studentID');
    if (removedStudentID != null){
      if (classroom.remove(removedStudentID)){
        updatePage(classroom);
      }
    } 
  });

       $(document).on('click', ".container", function(e) {
      document.getElementById("error1").style.visibility = "hidden";
  });

  $(document).on('click', ".removePreferTile", function(e) {
    var rowStudentID = $(this).closest('td').data('studentID');
    var tileStudentID = $(this).closest('p').data('studentID');
    var rowStudent = classroom.getStudentFromID(rowStudentID)
    var update_flag = rowStudent.removeFromPreferences('prefer', tileStudentID);
    if (update_flag){
      $(this).parent().remove();
      updateLocalStorage(classroom); 
    } 
  });

  $(document).on('click', ".removeAvoidTile", function(e) {
    var rowStudentID = $(this).closest('td').data('studentID');
    var tileStudentID = $(this).closest('p').data('studentID');
    var rowStudent = classroom.getStudentFromID(rowStudentID)
    var update_flag = rowStudent.removeFromPreferences('avoid', tileStudentID);
    if (update_flag){
      $(this).parent().remove();
      updateLocalStorage(classroom);
    } 
  });

  //input classname textbox placeholder listeners
  $("#classname_input").data('holder', ADD_CLASSNAME_PLACEHOLDER);
  $("#classname_input").on('focus', function(){
    $(this).attr('placeholder', '')
  });
  $("#classname_input").on('focusout', function(){
    $(this).attr('placeholder', $(this).data('holder'))
  });
  $("#classname_input").attr('placeholder', ADD_CLASSNAME_PLACEHOLDER);
  $(document).on('keyup', "#classname_input", function(e) {
    var charCode = event.which || event.keyCode;
    if (charCode == '13'){
      $('input').blur();
    }
  });

  //input student textbox placeholder listeners
  $("#add_student_box").data('holder', ADD_STUDENT_BOX_PLACEHOLDER)
  $("#add_student_box").on('focus', function(){
  });
  $("#add_student_box").on('focusout', function(){
    $(this).attr('placeholder',  $(this).data('holder'));
  });
  $("#add_student_box").attr('placeholder', ADD_STUDENT_BOX_PLACEHOLDER);


  $(document).on('keyup', "#add_student_box", function(e) {
    var charCode = e.which || e.keyCode;
    if (charCode == '13'){
      console.log($("#add_student_box").val());
      classroom = parseStudentList(classroom);
      $("#add_student_box").val("");
      updatePage(classroom);
      updateLocalStorage(classroom); 
    }
  });

  $("#add_student_box").on('paste', function(e) {setTimeout(function() {
    var e = $.Event( 'keyup', { which: $.ui.keyCode.ENTER } );
    $('#add_student_box').trigger(e);
  }), 0});

  function lightDroppable() {
    // Get the studentID of the tile being dragged, and determine
    // if it is a blue tile or not because the rules are slightly different.
    var blueTile = false;
    var studentID = $(this).data('studentID');
    if (!studentID) {
       studentID = $(this).parent().data('studentID');
       blueTile = true;
    }
    // We should not be allowed to drag into a cell that already contains
    // a tile with our studentID, nor into the row with the blue tile for
    // our studentID.
    var omitRows = $('p').filter(function() {
      return $(this).data('studentID') == studentID;
    }).closest('tr').add($('td').filter(function() {
      return $(this).data('studentID') == studentID;
    }));
    // If we are dragging a non-blue tile, we can drag within our row.
    if (!blueTile) {
      omitRows = omitRows.not($(this).closest('tr'));
    }
    $('.pair_with,.dont_pair_with').filter(function() {
      return $(this).closest(omitRows).length == 0;
    }).toggleClass('candrop', true);
  }

  function clearDroppable() {
    $('.candrop').toggleClass('candrop', false);
  }

  var ENABLE_INLINE_ENTRY = true;

  // The code below supports inline entry of pair-with and dont-pair-with
  // preferences.  It is not done yet, but it won't take much work to
  // complete.  All that needs to be implemented is the "addTypedPreference"
  // function at the bbottom of this section - that currently just logs
  // a message saying which student preference was added.
  if (ENABLE_INLINE_ENTRY) {
    function selectAll(editable) {
      try {
        var sel, range;
        if (window.getSelection && document.createRange) {
          range = document.createRange();
          range.selectNodeContents(editable);
          sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        } else if (document.body.createTextRange) {
          range = document.body.createTextRange();
          range.moveToElementText(editable);
          range.select();
        }
      } catch (e) { }
    }
    var editableSpan = null;
    function startEditing(cell) {
      if (editableSpan) finishEditing();
      editableSpan = $('<div class=directentry contentEditable=true>')
          .appendTo(cell);
      editableSpan.on('keydown', function(e) {
        if (e.which == 13 || // enter
            e.which == 9 || // tab
            e.which == 188 || // comma
            e.which == 186) { // semicolon

          // Use some dead reckoning to recover cursor position after
          // re-rendering the whole table.
          var editable_cells = 'td.pair_with,td.dont_pair_with';
          var rememberedLocation = $(editable_cells).index(cell);
          // Handle tab order: exiting with tab brings cursor to next/prev cell.
          if (e.which == 9) { rememberedLocation += e.shiftKey ? -1 : 1; }
          // Read what was typed and commit the transaction.
          document.getElementById("error1").style.visibility = "hidden";
          finishEditing();
          // Try bringing cursor back to the same cell.

          setTimeout(function() {
            startEditing($(editable_cells).eq(rememberedLocation));
          }, 0);
        }
      });
      editableSpan.on('blur', finishEditing);
      selectAll(editableSpan[0]);
      editableSpan.focus();
    }

    function finishEditing() {

      addTypedPreference(
          editableSpan.closest('tr').find('td').eq(0).data('studentID'),
          editableSpan.closest('tr').find('td').eq(0).text(),
          editableSpan.closest('td').hasClass('pair_with') ? 'prefer' : 'avoid',
          editableSpan.text().trim());
      editableSpan.remove();
      editableSpan = null;
    }

    // Does a rough match for the student name, preferring an exact match,
    // but allowing a case-insensitive prefix match.
    function findClosestStudentMatch(typedName) {
      var students = classroom.getStudents();
      var bestMatch = null;
      var bestScore = 0;
      for (var j = 0; j < students.length; ++j) {
        var student = students[j];
        var name = student.name();
        if (name == typedName) {
          return student;
        }
        var matchedCase = true;
        for (var k = 0; k < name.length && k < typedName.length; ++k) {
          if (name[k] != typedName[k]) {
            if (name[k].toLowerCase() != typedName[k].toLowerCase()) {
              break;
            }
            matchedCase = false;
          }
        }
        var score = k * 2 - (matchedCase ? 0 : 1);
        if (score > bestScore) {
          console.log('score is', score, 'for', student.name());
          bestScore = score;
          bestMatch = student;
        }
      }
      return bestMatch;
    }

    function addTypedPreference(studentID, studentName, pref, typedName) {
      // Figure out which student name was (approximately) typed.
      console.log("typedname is");
      console.log(typedName);
      var typedStudent = findClosestStudentMatch(typedName);
      if (typedStudent == null) {
        if(typedName)
        {
          $("#error1").text("No student named \"" + typedName +
              "\" is in the list"); 
          document.getElementById("error1").style.visibility = "visible"; 
        }
        return;
      }
      // Figure out which row we were typing into.
      var prefStudent = classroom.getStudentFromID(studentID);
      if (prefStudent == null || prefStudent == typedStudent) { 
        if(typedName)
        {
          $("#error1").text("A Student cannot be entered in his own preferences"); 
          document.getElementById("error1").style.visibility = "visible"; 
        }
        return;
      }
      // Modify the actual preference.
      prefStudent.addToPreferences(pref, typedStudent.id());
      updatePage(classroom);
      updateLocalStorage(classroom);
    }
  }

  // Content editable behavior for pair_with / dont_pair_with cells
  $("table").on('click', 'td.pair_with,td.dont_pair_with', function (e) {
    if (!$(this).is('td')) { return; }
    startEditing(this);
  });

  //drag and drop behavior for name tiles
  $("table").on('mouseenter',".tile_name", function() {
    $(this).css( 'cursor', 'grabbing' )
    $(this).css( 'z-index', DRAGGABLE_Z_INDEX);

    var todrag = $(this);
    var tileStudentID = todrag.parent().data("studentID")
    todrag.draggable({
        start: lightDroppable,
        stop: clearDroppable,
        helper: 'clone',
        cursorAt: { top: 8, left: 20 }, /* To deal with small tile */
        revert: true,
        containment: $('tbody'),
        revertDuration: REVERT_SPEED_DURATION,
        opacity: 0.75,
    });

    $(".pair_with").droppable({
      accept: "p",
      hoverClass: "highlight",
      drop: function(event, ui) {
        var targetStudentID = $(event.target).data("studentID");
        if (targetStudentID != tileStudentID){
          var targetStudent = classroom.getStudentFromID(targetStudentID);
            var update_flag = classroom.getStudentFromID(targetStudentID).addToPreferences('prefer', tileStudentID);
              if (update_flag){
                updatePage(classroom);
                updateLocalStorage(classroom); 
              } 
           }
        }
    });

    $(".dont_pair_with").droppable({
      accept: "p",
      hoverClass: "highlight",
      drop: function(event,ui) {
        var targetStudentID = $(this).data("studentID");
        if (targetStudentID != tileStudentID){
          var targetStudent = classroom.getStudentFromID(targetStudentID);
            var update_flag = classroom.getStudentFromID(targetStudentID).addToPreferences('avoid', tileStudentID);
              if (update_flag){
                updatePage(classroom);
                updateLocalStorage(classroom);
              } 
          
        }
      }
    });
  });

  //drag and drop behavior for pair_with tiles
  $("table").on('mouseenter',".tile_prefer", function() {
    $(this).css( 'cursor', 'grabbing' );
    var todrag = $(this);
    var tileStudentID = todrag.data("studentID");
    var sourceStudentID = todrag.parent().data("studentID");
    todrag.draggable({
        start: lightDroppable,
        stop: clearDroppable,
        revert: true,
        cancel: 'span'
   });

  $(".pair_with").droppable({
      accept: "p",
      hoverClass: "highlight",
      drop: function(event, ui) {
        var targetStudentID = $(this).data("studentID");
        if ((targetStudentID != tileStudentID) && (targetStudentID != sourceStudentID)){
          var successfulRemoval = classroom.getStudentFromID(sourceStudentID).removeFromPreferences('prefer', tileStudentID);
          var successfulAddition = classroom.getStudentFromID(targetStudentID).addToPreferences('prefer', tileStudentID);
              if (successfulRemoval && successfulAddition){
                updatePage(classroom);
                updateLocalStorage(classroom); 
              } else {

              }
        } 
      }
    });

    $(".dont_pair_with").droppable({
      accept: "p",
      hoverClass: "highlight",
      drop: function(event,ui) {
        var targetStudentID = $(this).data("studentID");
        if (targetStudentID != tileStudentID) {
          var successfulAddition = classroom.getStudentFromID(sourceStudentID).removeFromPreferences('prefer', tileStudentID);
          var successfulRemoval = classroom.getStudentFromID(targetStudentID).addToPreferences('avoid', tileStudentID);
              if (successfulAddition && successfulRemoval){
                updatePage(classroom);
                updateLocalStorage(classroom); 
              } 
        } 
      }
    });
  });

  //drag and drop behavior for dont_pair_with tiles
  $("table").on('mouseenter',".tile_avoid", function() {
    $(this).css( 'cursor', 'grabbing' );
    var todrag = $(this);
    var tileStudentID = todrag.data("studentID");
    var sourceStudentID = todrag.parent().data("studentID");

    todrag.draggable({
        start: lightDroppable,
        stop: clearDroppable,
        revert: true,
        cancel: 'span'
    });

    $(".pair_with").droppable({
      accept: "p",
      hoverClass: "highlight",
      drop: function(event, ui) {
        var targetStudentID = $(this).data("studentID");
        if (targetStudentID != tileStudentID){
          var successfulRemoval = classroom.getStudentFromID(sourceStudentID).removeFromPreferences('avoid', tileStudentID);
          var successfulAddition = classroom.getStudentFromID(targetStudentID).addToPreferences('prefer', tileStudentID);
              if (successfulAddition && successfulRemoval){
                updatePage(classroom);
                updateLocalStorage(classroom); 
              } 
        } 
      }
    });

    $(".dont_pair_with").droppable({
      accept: "p",
      hoverClass: "highlight",
      drop: function(event,ui) {
        var targetStudentID = $(this).data("studentID");
        if ((targetStudentID != tileStudentID) && (targetStudentID != sourceStudentID)){
          var successfulRemoval = classroom.getStudentFromID(sourceStudentID).removeFromPreferences('avoid', tileStudentID);
          var successfulAddition = classroom.getStudentFromID(targetStudentID).addToPreferences('avoid', tileStudentID);
              if (successfulAddition && successfulRemoval){
                updatePage(classroom);
                updateLocalStorage(classroom); 
              } 
        } 
      }
    });
  
  });



  $('input:checkbox').change(
    function(){
        $("body").toggleClass('hideprefs', !$(this).is(':checked'));
        var savedstate = "hide";
        if ($(this).is(':checked')) {
          savedstate = "show";
        }
        localStorage.setItem('hideprefs', savedstate);
    });

  /*group size input*/
  $("#decrease_group_size").click(function(){
    var students_per_group = $("#group_size_container").data('students_per_group');
    var new_students_per_group = Math.max(students_per_group - 1, MIN_STUDENTS_PER_GROUP)
    if (new_students_per_group < students_per_group){
      updateStudentsPerGroup(classroom, new_students_per_group);
      updateLocalStorage(classroom); 
    }
    $("#decrease_group_size").blur();
  })

  $("#increase_group_size").click(function(){
    var students_per_group = $("#group_size_container").data('students_per_group');
    var new_students_per_group = Math.min(students_per_group + 1, MAX_STUDENTS_PER_GROUP);
    var new_students_per_group = Math.min(new_students_per_group, classroom.getSize());
    if (new_students_per_group > students_per_group){
      updateStudentsPerGroup(classroom, new_students_per_group);
      updateLocalStorage(classroom); 
    }
    $("#increase_group_size").blur();
  })
    

  isValidStudentsPerGroup = function(group_size){
    var typeOK = (typeof group_size === 'number') && (group_size % 1 === 0);
    var sizeOK = (group_size >= MIN_STUDENTS_PER_GROUP) && (group_size <= MAX_STUDENTS_PER_GROUP);
    return typeOK && sizeOK
  }

  
  //group'em button listener
  $("#groupem_button").click(function(){
    if (classroom.getSize() >= MIN_STUDENTS_PER_GROUP){
      location.href = "group-view.html";
      localStorage.removeItem('grouping')
      localStorage.removeItem('nodeLocations');
      localStorage.removeItem('clusterLocations');
    } else {
      alert("should never get here since groupem button should be disabled if size < MIN_STUDENTS_PER_GROUP")
    }
  });

  $("#new_class").click(function() {
    if (classroom.getSize() > 0) {
      savedclass = localStorage.getItem('classroom');
      //savedclass = classroom.fromJSON(savedclass);
      classroom = new Classlist();
      localStorage.removeItem('classroom');
      $("#undo_div").removeClass();
      updatePage(classroom);
    }
  });

  $("#undo").click(function() {
    classroom = new Classlist();
    classroom.fromJSON(savedclass);
    console.log(classroom);
    //updateLocalStorage(classroom);
    localStorage.setItem('classroom', classroom);
    $("#undo_div").addClass('invisible');
    updatePage(classroom);
  });


  //initialize classroom and students per group
  $("body").removeClass();
  $("body").addClass("hideprefs");
  var storedClassroom = localStorage.getItem('classroom');
  var hide = localStorage.getItem('hideprefs');
  console.log(hide);
  if (hide == "hide") {
    $('input:checkbox')
            .addClass('init').prop('checked', false)
            .trigger('change');
  }
  else {
    $('input:checkbox')
            .addClass('init').prop('checked', true)
            .trigger('change');
  }
  setTimeout(function() {
    // Enable transitions after initialization by removing the init class.
    // I do not know why this requires a delay.
    $('input:checkbox').removeClass('init');
  }, 0);


  if (storedClassroom == null && ADD_INITIAL_LIST) {
    classroom.add(new Student('berk', 1, {'prefer':[2], 'avoid':[3], 'pinned':[], 'banned':[]}));
    classroom.add(new Student('david', 2, {'prefer':[1], 'avoid':[4], 'pinned':[], 'banned':[]}));
    classroom.add(new Student('nick', 3, {'prefer':[4], 'avoid':[1], 'pinned':[], 'banned':[]}));
    classroom.add(new Student('shruti', 4, {'prefer':[3], 'avoid':[2], 'pinned':[], 'banned':[]}));
  } else {
    classroom.fromJSON(storedClassroom);
    var storedStudentsPerGroup = parseInt(localStorage.getItem('students_per_group'));
    if (storedStudentsPerGroup != null){
       if (Number(storedStudentsPerGroup) === storedStudentsPerGroup && storedStudentsPerGroup % 1 === 0){
          $("#group_size_container").data('students_per_group', parseInt(storedStudentsPerGroup));  
       }
    }
  }
  updatePage(classroom);
  updateStudentsPerGroup(classroom, $("#group_size_container").data('students_per_group'));
  updateLocalStorage(classroom);
    // Show the tour

  
});

</script>
